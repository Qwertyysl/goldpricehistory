name: Update Gold Data

permissions:
  contents: write

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Ensure files exist
        run: |
          [ -f gold_7d.json ] || echo "[]" > gold_7d.json
          [ -f gold_24h.json ] || echo "[]" > gold_24h.json
          [ -f latest.json ] || echo "{}" > latest.json

      - name: Fetch gold price (browser mimic mode)
        run: |
          echo "Fetching gold API..."

          RESPONSE=$(curl -s -L \
            --http1.1 \
            --compressed \
            --connect-timeout 10 \
            --max-time 20 \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120 Safari/537.36" \
            -H "Accept: application/json, text/plain, */*" \
            -H "Accept-Language: en-US,en;q=0.9" \
            -H "Referer: https://goldprice.org/" \
            -H "Origin: https://goldprice.org" \
            https://data-asg.goldprice.org/dbXRates/MYR)

          if [ -z "$RESPONSE" ]; then
            echo "Empty response."
            exit 0
          fi

          if echo "$RESPONSE" | grep -q "<html"; then
            echo "Blocked (HTML returned)."
            exit 0
          fi

          echo "$RESPONSE" | jq . > /dev/null 2>&1 || exit 0

          PRICE=$(echo "$RESPONSE" | jq -r '
            .items[0].y //
            .items[0].xauPrice //
            .items[0].price //
            .price //
            empty
          ')

          if [ -z "$PRICE" ]; then
            echo "Price not found."
            exit 0
          fi

          TIMESTAMP=$(date +%s)

          NEW=$(jq -n \
            --arg ts "$TIMESTAMP" \
            --arg pr "$PRICE" \
            '{timestamp: ($ts|tonumber), price: ($pr|tonumber)}')

          echo "New data: $NEW"

          echo "$NEW" > latest.json

          LAST_TS=$(jq '.[-1].timestamp // 0' gold_7d.json)
          CURRENT_TS=$(echo "$NEW" | jq '.timestamp')

          if [ "$CURRENT_TS" != "$LAST_TS" ]; then
            jq ". += [$NEW]" gold_7d.json > tmp.json
            jq '.[-1008:]' tmp.json > gold_7d.json
            rm tmp.json
          fi

          jq '.[-144:]' gold_7d.json > gold_24h.json

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add gold_7d.json gold_24h.json latest.json

          if git diff --cached --quiet; then
            echo "No changes."
          else
            git commit -m "Auto update gold data"
            git push
          fi
