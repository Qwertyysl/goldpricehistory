name: Update Gold Data

permissions:
  contents: write

on:
  schedule:
    - cron: '* * * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Ensure files exist
        run: |
          [ -f gold_7d.json ] || echo "[]" > gold_7d.json
          [ -f gold_24h.json ] || echo "[]" > gold_24h.json
          [ -f latest.json ] || echo "{}" > latest.json

      - name: Fetch gold price (auto-detect structure)
        run: |
          echo "Fetching gold API..."
          RESPONSE=$(curl -s -L \
            --connect-timeout 10 \
            --max-time 20 \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)" \
            -H "Accept: application/json,text/plain,*/*" \
            https://data-asg.goldprice.org/dbXRates/MYR)

          if [ -z "$RESPONSE" ]; then
            echo "Empty response."
            exit 0
          fi

          if echo "$RESPONSE" | grep -q "<html"; then
            echo "Blocked (HTML returned)."
            # Optional: Print first few lines to debug
            echo "$RESPONSE" | head -n 5
            exit 0
          fi

          echo "$RESPONSE" | jq . > /dev/null 2>&1
          if [ $? -ne 0 ]; then
            echo "Invalid JSON."
            echo "$RESPONSE" | head -n 5
            exit 0
          fi

          # Flexible extraction attempt
          PRICE=$(echo "$RESPONSE" | jq -r '
            .items[0].y // 
            .items[0].xauPrice // 
            .items[0].price // 
            .price // 
            empty
          ')
          
          TIMESTAMP=$(echo "$RESPONSE" | jq -r '
            .items[0].x // 
            .items[0].timestamp // 
            .timestamp // 
            (now | floor)
          ')

          if [ -z "$PRICE" ] || [ "$PRICE" = "null" ]; then
            echo "Price not found in JSON."
            echo "DEBUG STRUCTURE:"
            echo "$RESPONSE" | jq .
            exit 0
          fi

          NEW=$(jq -n \
            --arg ts "$TIMESTAMP" \
            --arg pr "$PRICE" \
            '{timestamp: ($ts|tonumber), price: ($pr|tonumber)}')
          
          echo "New data: $NEW"
          
          # Save latest
          echo "$NEW" > latest.json

          if [ ! -s gold_7d.json ]; then echo "[]" > gold_7d.json; fi
          
          LAST_TS=$(jq '.[-1].timestamp // 0' gold_7d.json)
          CURRENT_TS=$(echo "$NEW" | jq '.timestamp')

          if [ "$CURRENT_TS" = "$LAST_TS" ]; then
            echo "Duplicate timestamp. Skip append."
            exit 0
          fi

          jq --argjson new "$NEW" '. += [$new]' gold_7d.json > temp.json
          jq '.[-1008:]' temp.json > gold_7d.json
          rm temp.json
          
          jq '.[-144:]' gold_7d.json > gold_24h.json
          
      - name: Commit and push (safe mode)
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add gold_7d.json gold_24h.json latest.json

          if git diff --cached --quiet; then
            echo "No changes."
            exit 0
          fi

          git commit -m "Auto update gold data"

          # Fetch latest remote state
          git fetch origin main

          # Rebase on top of remote
          git rebase origin/main

          # Push safely
          git push origin main

