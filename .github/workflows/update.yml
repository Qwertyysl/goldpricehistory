name: Update Gold Data

permissions:
  contents: write

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Ensure JSON files exist
        run: |
          [ -f gold_7d.json ] || echo "[]" > gold_7d.json
          [ -f gold_24h.json ] || echo "[]" > gold_24h.json
          [ -f latest.json ] || echo "{}" > latest.json

      - name: Fetch gold price
        run: |
          echo "Fetching gold API..."

          RESPONSE=$(curl -s -L \
            -H "User-Agent: Mozilla/5.0" \
            -H "Accept: application/json" \
            https://data-asg.goldprice.org/dbXRates/MYR)

          echo "$RESPONSE" | jq . > /dev/null 2>&1 || exit 0

          PRICE=$(echo "$RESPONSE" | jq -r '.items[0].y // .items[0].xauPrice // .items[0].price // .price')

          if [ -z "$PRICE" ] || [ "$PRICE" = "null" ]; then
            echo "Price not found."
            exit 0
          fi

          TIMESTAMP=$(date +%s)

          NEW=$(jq -n \
            --arg ts "$TIMESTAMP" \
            --arg pr "$PRICE" \
            '{timestamp: ($ts|tonumber), price: ($pr|tonumber)}')

          echo "New data: $NEW"

          echo "$NEW" > latest.json

          LAST_TS=$(jq '.[-1].timestamp // 0' gold_7d.json)
          CURRENT_TS=$(echo "$NEW" | jq '.timestamp')

          if [ "$CURRENT_TS" != "$LAST_TS" ]; then
            jq ". += [$NEW]" gold_7d.json > tmp.json
            jq '.[-1008:]' tmp.json > gold_7d.json
            rm tmp.json
          fi

          jq '.[-144:]' gold_7d.json > gold_24h.json

      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git pull --rebase

          git add gold_7d.json gold_24h.json latest.json

          if git diff --cached --quiet; then
            echo "No changes."
            exit 0
          fi

          git commit -m "Auto update gold data"
          git push
