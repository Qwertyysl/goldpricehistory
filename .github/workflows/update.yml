name: Update Gold Data

permissions:
  contents: write

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install jq & bc
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc

      - name: Ensure files exist
        run: |
          [ -f gold_7d.json ] || echo "[]" > gold_7d.json
          [ -f gold_24h.json ] || echo "[]" > gold_24h.json
          [ -f latest.json ] || echo "{}" > latest.json
          [ -f miga_latest.json ] || echo "{}" > miga_latest.json

# ================= GOLD SECTION =================

      - name: Fetch gold price (convert to RM/g)
        run: |
          echo "Fetching gold API..."

          RESPONSE=$(curl -s -L \
            --http1.1 \
            --retry 3 \
            --connect-timeout 20 \
            --max-time 40 \
            -H "User-Agent: Mozilla/5.0" \
            https://data-asg.goldprice.org/dbXRates/MYR || true)

          if [ -z "$RESPONSE" ]; then exit 0; fi
          if echo "$RESPONSE" | grep -q "<html"; then exit 0; fi

          RAW_PRICE=$(echo "$RESPONSE" | jq -r '
            .items[0].y //
            .items[0].xauPrice //
            .items[0].price //
            .price //
            empty
          ')

          if [ -z "$RAW_PRICE" ]; then exit 0; fi

          PRICE=$(echo "$RAW_PRICE / 31.1034768" | bc -l)
          PRICE=$(printf "%.2f" "$PRICE")

          TIMESTAMP=$(date +%s)

          NEW=$(jq -n \
            --arg ts "$TIMESTAMP" \
            --arg pr "$PRICE" \
            '{timestamp: ($ts|tonumber), price: ($pr|tonumber)}')

          echo "$NEW" > latest.json

          LAST_TS=$(jq '.[-1].timestamp // 0' gold_7d.json)
          CURRENT_TS=$(echo "$NEW" | jq '.timestamp')

          if [ "$CURRENT_TS" != "$LAST_TS" ]; then
            jq ". += [$NEW]" gold_7d.json > tmp.json
            jq '.[-1008:]' tmp.json > gold_7d.json
            rm tmp.json
          fi

          jq '.[-144:]' gold_7d.json > gold_24h.json


# ================= PLAYWRIGHT SETUP =================

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium


# ================= MIGA SECTION =================

      - name: Fetch MIGA below 100g (Playwright)
        run: |
          cat << 'EOF' > scrape.js
          const { chromium } = require('playwright');
          const fs = require('fs');

          (async () => {
            try {
              const browser = await chromium.launch({ headless: true });
              const page = await browser.newPage();

              await page.goto(
                'https://www.maybank2u.com.my/maybank2u/malaysia/en/personal/rates/gold_and_silver.page',
                { waitUntil: 'networkidle', timeout: 60000 }
              );

              const row = page.locator('tr:has-text("For below 100 grams")').first();

              if (!(await row.count())) {
                console.log("Row not found.");
                await browser.close();
                process.exit(0);
              }

              const cells = await row.locator('td').allTextContents();

              if (cells.length < 3) {
                console.log("Invalid row structure.");
                await browser.close();
                process.exit(0);
              }

              const sell = parseFloat(cells[1]);
              const buy = parseFloat(cells[2]);

              const data = {
                timestamp: Math.floor(Date.now() / 1000),
                sell,
                buy
              };

              fs.writeFileSync('miga_latest.json', JSON.stringify(data, null, 2));

              console.log("MIGA updated:", data);

              await browser.close();
            } catch (err) {
              console.log("Playwright error:", err.message);
              process.exit(0);
            }
          })();
          EOF

          node scrape.js


# ================= COMMIT =================

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add gold_7d.json gold_24h.json latest.json miga_latest.json

          if git diff --cached --quiet; then
            echo "No changes."
          else
            git commit -m "Auto update gold + MIGA data"
            git push
          fi
