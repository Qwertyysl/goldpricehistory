name: Update Gold Data

permissions:
  contents: write

on:
  schedule:
    - cron: '* * * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      # Checkout with full history (important for rebase)
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Ensure files exist
        run: |
          [ -f gold_7d.json ] || echo "[]" > gold_7d.json
          [ -f gold_24h.json ] || echo "[]" > gold_24h.json
          [ -f latest.json ] || echo "{}" > latest.json

      - name: Fetch gold price
        run: |
          echo "Fetching gold API..."

          RESPONSE=$(curl -s -L \
            --connect-timeout 10 \
            --max-time 20 \
            -H "User-Agent: Mozilla/5.0" \
            -H "Accept: application/json" \
            https://data-asg.goldprice.org/dbXRates/MYR)

          if [ -z "$RESPONSE" ]; then
            echo "Empty response."
            exit 0
          fi

          if echo "$RESPONSE" | grep -q "<html"; then
            echo "Blocked (HTML returned)."
            exit 0
          fi

          echo "$RESPONSE" | jq . > /dev/null 2>&1
          if [ $? -ne 0 ]; then
            echo "Invalid JSON."
            exit 0
          fi

          PRICE=$(echo "$RESPONSE" | jq -r '
            .items[0].y //
            .items[0].xauPrice //
            .items[0].price //
            .price //
            empty
          ')

          TIMESTAMP=$(echo "$RESPONSE" | jq -r '
            .items[0].x //
            .items[0].timestamp //
            .timestamp //
            (now | floor)
          ')

          if [ -z "$PRICE" ]; then
            echo "Price not found."
            exit 0
          fi

          NEW=$(jq -n \
            --arg ts "$TIMESTAMP" \
            --arg pr "$PRICE" \
            '{timestamp: ($ts|tonumber), price: ($pr|tonumber)}')

          echo "New data: $NEW"

          echo "$NEW" > latest.json

          LAST_TS=$(jq '.[-1].timestamp // 0' gold_7d.json)
          CURRENT_TS=$(echo "$NEW" | jq '.timestamp')

          if [ "$CURRENT_TS" = "$LAST_TS" ]; then
            echo "Duplicate timestamp. Skip append."
            exit 0
          fi

          jq ". += [$NEW]" gold_7d.json > temp.json
          jq '.[-1008:]' temp.json > gold_7d.json
          rm temp.json

          jq '.[-144:]' gold_7d.json > gold_24h.json

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          # Sync with remote first (prevent conflict)
          git pull origin main --rebase

          git add gold_7d.json gold_24h.json latest.json

          if git diff --cached --quiet; then
            echo "No changes."
            exit 0
          fi

          git commit -m "Auto update gold data"
          git push origin HEAD:main
