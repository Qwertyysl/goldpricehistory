name: Update Gold Data

permissions:
  contents: write

on:
  schedule:
    - cron: '* * * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch gold price
        id: fetch
        run: |
          RESPONSE=$(curl -s -L \
            -H "User-Agent: Mozilla/5.0" \
            -H "Accept: application/json" \
            https://data-asg.goldprice.org/dbXRates/MYR)

          echo "$RESPONSE" | jq . > /dev/null 2>&1 || exit 0

          PRICE=$(echo "$RESPONSE" | jq -r '
            .items[0].y //
            .items[0].xauPrice //
            .items[0].price //
            .price //
            empty
          ')

          TIMESTAMP=$(echo "$RESPONSE" | jq -r '
            .items[0].x //
            .items[0].timestamp //
            .timestamp //
            (now | floor)
          ')

          [ -z "$PRICE" ] && exit 0

          NEW=$(jq -n \
            --arg ts "$TIMESTAMP" \
            --arg pr "$PRICE" \
            '{timestamp: ($ts|tonumber), price: ($pr|tonumber)}')

          echo "new=$NEW" >> $GITHUB_OUTPUT

      - name: Update files via GitHub API
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          API="https://api.github.com/repos/$REPO/contents"

          NEW='${{ steps.fetch.outputs.new }}'

          [ -z "$NEW" ] && exit 0

          update_file () {
            FILE=$1
            CONTENT=$2

            SHA=$(curl -s \
              -H "Authorization: Bearer $GH_TOKEN" \
              $API/$FILE | jq -r '.sha // empty')

            BASE64=$(echo "$CONTENT" | base64 -w 0)

            curl -s -X PUT \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              $API/$FILE \
              -d "{
                \"message\": \"Auto update gold data\",
                \"content\": \"$BASE64\",
                \"sha\": \"$SHA\"
              }"
          }

          # Get existing 7d data
          EXISTING=$(curl -s \
            -H "Authorization: Bearer $GH_TOKEN" \
            $API/gold_7d.json | jq -r '.content // empty' | base64 -d 2>/dev/null)

          [ -z "$EXISTING" ] && EXISTING="[]"

          LAST_TS=$(echo "$EXISTING" | jq '.[-1].timestamp // 0')
          CURRENT_TS=$(echo "$NEW" | jq '.timestamp')

          if [ "$CURRENT_TS" != "$LAST_TS" ]; then
            UPDATED=$(echo "$EXISTING" | jq ". += [$NEW]" | jq '.[-1008:]')
          else
            UPDATED="$EXISTING"
          fi

          UPDATE_24H=$(echo "$UPDATED" | jq '.[-144:]')

          update_file gold_7d.json "$UPDATED"
          update_file gold_24h.json "$UPDATE_24H"
          update_file latest.json "$NEW"
